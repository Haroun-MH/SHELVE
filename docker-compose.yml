version: '3.8'

services:
  # ===================
  # Infrastructure
  # ===================
  
  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3-management
    container_name: shelve-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: shelve
      RABBITMQ_DEFAULT_PASS: shelve123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # ===================
  # Databases
  # ===================
  
  # Auth Service Database
  auth-db:
    image: postgres:15-alpine
    container_name: shelve-auth-db
    environment:
      POSTGRES_DB: shelve_auth
      POSTGRES_USER: shelve
      POSTGRES_PASSWORD: shelve123
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shelve -d shelve_auth"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shelve-network

  # Book Catalog Service Database
  book-db:
    image: postgres:15-alpine
    container_name: shelve-book-db
    environment:
      POSTGRES_DB: shelve_books
      POSTGRES_USER: shelve
      POSTGRES_PASSWORD: shelve123
    volumes:
      - book_db_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shelve -d shelve_books"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shelve-network

  # Shelf Service Database
  shelf-db:
    image: postgres:15-alpine
    container_name: shelve-shelf-db
    environment:
      POSTGRES_DB: shelve_shelf
      POSTGRES_USER: shelve
      POSTGRES_PASSWORD: shelve123
    volumes:
      - shelf_db_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shelve -d shelve_shelf"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shelve-network

  # Review/Rating Service Database
  review-db:
    image: postgres:15-alpine
    container_name: shelve-review-db
    environment:
      POSTGRES_DB: shelve_reviews
      POSTGRES_USER: shelve
      POSTGRES_PASSWORD: shelve123
    volumes:
      - review_db_data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shelve -d shelve_reviews"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shelve-network

  # Recommendation Service Database
  recommendation-db:
    image: postgres:15-alpine
    container_name: shelve-recommendation-db
    environment:
      POSTGRES_DB: shelve_recommendations
      POSTGRES_USER: shelve
      POSTGRES_PASSWORD: shelve123
    volumes:
      - recommendation_db_data:/var/lib/postgresql/data
    ports:
      - "5436:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shelve -d shelve_recommendations"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shelve-network

  # ===================
  # Spring Cloud Services
  # ===================
  
  # Config Server
  config-server:
    build:
      context: ./config-server
      dockerfile: Dockerfile
    container_name: shelve-config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=native,docker
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # Discovery Server (Eureka)
  discovery-server:
    build:
      context: ./discovery-server
      dockerfile: Dockerfile
    container_name: shelve-discovery-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
    depends_on:
      config-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: shelve-api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # ===================
  # Business Services
  # ===================
  
  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: shelve-auth-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://auth-db:5432/shelve_auth
      - SPRING_DATASOURCE_USERNAME=shelve
      - SPRING_DATASOURCE_PASSWORD=shelve123
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      auth-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # Book Catalog Service
  book-catalog-service:
    build:
      context: ./book-catalog-service
      dockerfile: Dockerfile
    container_name: shelve-book-catalog-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://book-db:5432/shelve_books
      - SPRING_DATASOURCE_USERNAME=shelve
      - SPRING_DATASOURCE_PASSWORD=shelve123
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      book-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # Shelf Service
  shelf-service:
    build:
      context: ./shelf-service
      dockerfile: Dockerfile
    container_name: shelve-shelf-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://shelf-db:5432/shelve_shelf
      - SPRING_DATASOURCE_USERNAME=shelve
      - SPRING_DATASOURCE_PASSWORD=shelve123
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=shelve
      - SPRING_RABBITMQ_PASSWORD=shelve123
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      shelf-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # Review/Rating Service
  review-rating-service:
    build:
      context: ./review-rating-service
      dockerfile: Dockerfile
    container_name: shelve-review-rating-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://review-db:5432/shelve_reviews
      - SPRING_DATASOURCE_USERNAME=shelve
      - SPRING_DATASOURCE_PASSWORD=shelve123
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=shelve
      - SPRING_RABBITMQ_PASSWORD=shelve123
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      review-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # Recommendation Service (Python)
  recommendation-service:
    build:
      context: ./recommendation-service
      dockerfile: Dockerfile
    container_name: shelve-recommendation-service
    ports:
      - "8085:8085"
    environment:
      - DATABASE_URL=postgresql://shelve:shelve123@recommendation-db:5432/shelve_recommendations
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=shelve
      - RABBITMQ_PASSWORD=shelve123
      - BOOK_CATALOG_SERVICE_URL=http://api-gateway:8080/api/books
      - RATING_SERVICE_URL=http://api-gateway:8080/api/ratings
      - EUREKA_SERVER_URL=http://discovery-server:8761/eureka
    depends_on:
      discovery-server:
        condition: service_healthy
      recommendation-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - shelve-network

  # ===================
  # Frontend
  # ===================
  
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: shelve-frontend
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - shelve-network

networks:
  shelve-network:
    driver: bridge

volumes:
  rabbitmq_data:
  auth_db_data:
  book_db_data:
  shelf_db_data:
  review_db_data:
  recommendation_db_data:
